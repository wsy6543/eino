# 告警分析 Agent 系统

这是一个基于 eino 框架实现的智能告警分析系统，采用 **Manager-Experts** 多 Agent 协作模式，通过多轮迭代分析实现故障诊断和根因分析。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        告警触发                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    启动分析倒计时                            │
│                  (收集一段时间内的告警)                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       告警池                                 │
│            存储一段时间内的所有告警数据                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    启动分析任务                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Manager: 场景识别与计划生成                                 │
│  - 识别故障场景（性能问题、可用性问题等）                     │
│  - 制定分析计划                                             │
│  - 确定优先级和迭代轮次                                      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    迭代分析流程                              │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 第 1 轮                                            │     │
│  │   - Manager 分派任务给 3 个专家                     │     │
│  │   - 3 个专家并行分析                               │     │
│  │   - Manager 汇总结果并做出决策                      │     │
│  │   - 判断是否需要继续分析                           │     │
│  └────────────────────────────────────────────────────┘     │
│                          │                                   │
│                          ▼ (需要继续)                        │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 第 2 轮                                            │     │
│  │   - 基于第 1 轮结果继续深入分析                     │     │
│  │   - 重复分派、分析、汇总流程                        │     │
│  └────────────────────────────────────────────────────┘     │
│                          │                                   │
│                          ▼ (需要继续)                        │
│  ┌────────────────────────────────────────────────────┐     │
│  │ 第 N 轮                                            │     │
│  │   - 直至获得高置信度结论或达到最大轮次              │     │
│  └────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Manager: 报告生成                                          │
│  - 汇总所有轮次的分析结果                                    │
│  - 生成完整的故障分析报告                                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                         结束                                 │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 0. Skill Library (技能库)

可复用的故障处理原子能力，按类别分为：

**数据采集类**:
- `log_query` - 日志查询：查询指定时间范围的日志
- `metric_query` - 监控指标查询：查询 CPU、内存、网络等指标
- `trace_query` - 链路追踪：查询分布式追踪信息
- `topology_query` - 拓扑分析：分析服务依赖关系

**分析类**:
- `timeseries_analysis` - 时间序列分析：分析趋势和异常点
- `correlation_analysis` - 关联分析：分析指标间关联关系
- `pattern_matching` - 模式匹配：匹配已知故障模式
- `history_match` - 历史案例匹配：匹配相似历史故障
- `rootcause_analysis` - 根因分析：深度分析根本原因
- `fault_propagation` - 故障传播分析：分析故障传播路径

**诊断类**:
- `slowquery_analysis` - 慢查询分析：分析数据库慢查询
- `errorlog_analysis` - 错误日志分析：分析错误日志模式
- `resource_leak_detection` - 资源泄漏检测：检测连接/内存泄漏
- `network_diagnosis` - 网络诊断：诊断网络连接问题
- `memory_analysis` - 内存分析：分析内存使用情况

所有技能都有 mock 实现，可以直接使用。生产环境可替换为真实的工具调用。

### 技能分配总览

| 技能类型 | 故障诊断专家 | 性能分析专家 | 业务影响专家 |
|---------|------------|------------|------------|
| 数据采集 |
| log_query | ✅ | | |
| metric_query | ✅ | ✅ | |
| trace_query | ✅ | | |
| topology_query | ✅ | | ✅ |
| 分析能力 |
| timeseries_analysis | | ✅ | |
| correlation_analysis | | ✅ | ✅ |
| pattern_matching | ✅ | | |
| history_match | ✅ | | ✅ |
| rootcause_analysis | ✅ | | |
| fault_propagation | ✅ | | |
| 诊断能力 |
| slowquery_analysis | | ✅ | |
| errorlog_analysis | ✅ | | |
| memory_analysis | | ✅ | |

### 1. Manager Agent

负责协调整个分析流程：
- **场景识别**：分析告警特征，识别故障类型
- **计划生成**：制定分析策略，确定迭代轮次
- **任务分派**：将分析任务分配给各个专家
- **结果汇总**：综合专家意见，做出决策
- **报告生成**：生成最终的分析报告

### 2. Expert Agents

三个专业领域的专家 Agent，并行分析。每个专家具备不同的技能集合：

#### 故障诊断专家
**职责**: 分析系统故障的根本原因、追踪故障传播路径、识别故障模式

**具备的技能** (9个):
- `log_query` - 日志查询
- `metric_query` - 监控指标查询
- `trace_query` - 链路追踪
- `topology_query` - 拓扑分析
- `errorlog_analysis` - 错误日志分析
- `rootcause_analysis` - 根因分析
- `pattern_matching` - 模式匹配
- `fault_propagation` - 故障传播分析
- `history_match` - 历史案例匹配

#### 性能分析专家
**职责**: 分析性能指标、识别性能瓶颈、评估资源使用情况

**具备的技能** (5个):
- `metric_query` - 监控指标查询
- `timeseries_analysis` - 时间序列分析
- `correlation_analysis` - 关联分析
- `slowquery_analysis` - 慢查询分析
- `memory_analysis` - 内存分析

#### 业务影响专家
**职责**: 评估故障对业务的影响、分析受影响的用户群体、估算业务损失

**具备的技能** (3个):
- `topology_query` - 拓扑分析
- `history_match` - 历史案例匹配
- `correlation_analysis` - 关联分析

### 3. 告警池

- 存储一段时间内的所有告警数据
- 支持按级别、时间等维度查询
- 自动清理过期告警

## 使用方法

### 基本使用

```bash
cd examples/agent/alert_analysis
go run .
```

### 集成真实的 LLM

当前示例使用模拟的 ChatModel。要使用真实的 OpenAI 模型：

1. 安装 eino-ext：

```bash
go get github.com/cloudwego/eino-ext/components/model/openai
```

2. 修改 `main.go` 中的 ChatModel 创建：

```go
import "github.com/cloudwego/eino-ext/components/model/openai"

chatModel, err := openai.NewChatModel(ctx, &openai.ChatModelConfig{
    Model:   "gpt-4",
    APIKey:  os.Getenv("OPENAI_API_KEY"),
})
```

3. 取消注释代码中的 TODO 部分，启用实际的 ChatModel 调用

### 自定义配置

在 `main.go` 中可以调整：
- `maxRounds`：最大迭代轮次
- `poolSize`：告警池大小
- `retention`：告警保留时间

## 文件结构

```
alert_analysis/
├── main.go          # 主入口，演示如何使用系统
├── types.go         # 类型定义（告警、分析结果、报告等）
├── alarm_pool.go    # 告警池实现
├── skills.go        # 技能库实现（数据采集、分析、诊断等）
├── experts.go       # 专家 Agent 实现
├── manager.go       # Manager Agent 实现
└── README.md        # 本文件
```

## 工作流程示例

### 输入：告警数据

```go
alarms := []Alarm{
    {
        ID:          "ALERT-001",
        Level:       "critical",
        Title:       "API 响应时间异常",
        Description: "支付接口响应时间超过阈值 (P99 > 2000ms)",
        Service:     "payment-service",
        Metrics: map[string]float64{
            "p99_latency": 2340.0,
            "error_rate":  0.05,
        },
    },
    // ... 更多告警
}
```

### 输出：分析报告

```json
{
    "summary": "检测到支付服务存在严重性能问题，可能导致业务损失",
    "rootCause": "数据库连接池配置不当导致连接耗尽，进而影响API响应时间",
    "businessImpact": "影响约1500名用户，支付成功率下降约5%，预计造成收入损失",
    "performanceAnalysis": "P99延迟从200ms上升至2340ms，数据库连接使用率达到85%",
    "recommendations": [
        "立即增加数据库连接池大小",
        "优化慢查询，添加必要索引",
        "实施连接池监控和告警"
    ],
    "priority": "P0 - 紧急",
    "iterationsCompleted": 3
}
```

## 扩展建议

### 添加新的专家

1. 在 `experts.go` 中定义新的 `ExpertType`
2. 在 `NewExpertAgent` 中添加对应的 instruction
3. 在 `main.go` 中创建并注册新专家

### 集成外部工具

- 可以集成日志查询工具
- 可以集成监控数据查询接口
- 可以集成知识库检索

### 增强分析能力

- 添加时间序列分析
- 添加拓扑依赖分析
- 添加历史案例匹配

## 技术特点

- **多 Agent 协作**：采用 Supervisor 模式，Manager 协调多个专家
- **并行分析**：专家并行工作，提高分析效率
- **迭代优化**：通过多轮迭代逐步提升分析精度
- **上下文传递**：支持将前一轮结果传递到下一轮
- **可扩展**：易于添加新的专家和分析维度

## 注意事项

1. 当前示例使用简化的决策逻辑，生产环境需要集成真实的 LLM
2. 迭代终止策略可以根据实际需求调整
3. 告警池的大小和保留时间应根据实际负载配置
4. 建议添加错误处理和重试机制

## 参考

- [eino 官方文档](https://github.com/cloudwego/eino)
- [eino-examples](https://github.com/cloudwego/eino-examples)
- [ADK 文档](https://www.cloudwego.io/docs/eino/core_modules/eino_adk/)
